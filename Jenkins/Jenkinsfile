pipeline {
    agent any

    parameters {
        booleanParam(name: 'DESTROY_INFRA', defaultValue: false, description: 'Check this to tear down all AWS resources.')
        // Added the URL as a pipeline parameter
        string(name: 'CTFD_URL', defaultValue: 'http://ctfd-server:8000', description: 'The base URL of your CTFd instance.')
    }

    environment {
        TF_CHDIR = "terraform/" 
        AWS_DEFAULT_REGION = "us-east-1"
        // Ensure you have a 'Secret Text' credential in Jenkins with this ID
        CTFD_TOKEN = credentials('CTFD_ADMIN_TOKEN') 
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Terraform Plan') {
            when { expression { !params.DESTROY_INFRA } }
            steps {
                sh "terraform -chdir=${TF_CHDIR} init"
                sh "terraform -chdir=${TF_CHDIR} plan -out=tfplan"
            }
        }

        stage('Terraform Apply') {
            when { expression { !params.DESTROY_INFRA } }
            steps {
                sh "terraform -chdir=${TF_CHDIR} apply -auto-approve tfplan"
                
                // Save JSON for the plugin to consume (as requested in previous turn)
                sh "terraform -chdir=${TF_CHDIR} output -json > tf_output.json"
            }
        }

        stage('Pass Outputs to CTFd') {
            when { expression { !params.DESTROY_INFRA } }
            steps {
                script {
                    // Using the JSON file we just created to send to the API
                    // This matches the API endpoint we created in the plugin code
                    sh """
                        curl -X POST ${params.CTFD_URL}/api/v1/terraform/output \
                        -H "Authorization: Bearer ${CTFD_TOKEN}" \
                        -H "Content-Type: application/json" \
                        -d @tf_output.json
                    """
                }
            }
        }

        stage('Cleanup Infrastructure') {
            when { expression { params.DESTROY_INFRA } }
            steps {
                echo "Destroying infrastructure..."
                sh "terraform -chdir=${TF_CHDIR} destroy -auto-approve"
            }
        }
    }

    post {
        always {
            // Clean up workspace or sensitive plan files
            deleteDir()
        }
        failure {
            echo "Pipeline failed. Check Terraform logs or AWS Security Group limits."
        }
    }
}