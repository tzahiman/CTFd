pipeline {
    agent any

    parameters {
        booleanParam(name: 'DESTROY_INFRA', defaultValue: false, description: 'Check this to tear down all AWS resources.')
        string(name: 'CTFD_URL', defaultValue: 'http://ctfd-server:8000', description: 'The base URL of your CTFd instance.')
    }

    environment {
        TF_CHDIR = "terraform/" 
        AWS_DEFAULT_REGION = "us-east-1"
        // Ensure 'CTFD_ADMIN_TOKEN' is configured in Jenkins Credentials (Secret Text)
        CTFD_TOKEN = credentials('CTFD_ADMIN_TOKEN') 
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Terraform Plan') {
            when { expression { !params.DESTROY_INFRA } }
            steps {
                sh "terraform -chdir=${TF_CHDIR} init"
                sh "terraform -chdir=${TF_CHDIR} plan -out=tfplan"
            }
        }

        stage('Terraform Apply') {
            when { expression { !params.DESTROY_INFRA } }
            steps {
                sh "terraform -chdir=${TF_CHDIR} apply -auto-approve tfplan"
                
                // Generate JSON output for the CTFd plugin
                sh "terraform -chdir=${TF_CHDIR} output -json > tf_output.json"
                
                // Archive the output so it persists after the workspace is cleaned
                archiveArtifacts artifacts: 'tf_output.json', fingerprint: true
            }
        }

        stage('Pass Outputs to CTFd') {
            when { expression { !params.DESTROY_INFRA } }
            steps {
                script {
                    // Send the JSON to the CTFd custom API endpoint
                    sh """
                        curl -X POST ${params.CTFD_URL}/api/v1/terraform/output \
                        -H "Authorization: Bearer ${CTFD_TOKEN}" \
                        -H "Content-Type: application/json" \
                        -d @tf_output.json
                    """
                }
            }
        }

        stage('Cleanup Infrastructure') {
            when { expression { params.DESTROY_INFRA } }
            steps {
                echo "Destroying infrastructure..."
                sh "terraform -chdir=${TF_CHDIR} init"
                sh "terraform -chdir=${TF_CHDIR} destroy -auto-approve"
            }
        }
    }

    post {
        always {
            // cleanWs() is more robust than deleteDir() in declarative post blocks
            cleanWs()
        }
        failure {
            echo "Pipeline failed. Check Terraform logs, AWS quotas, or CTFd connectivity."
        }
        success {
            echo "Infrastructure successfully synchronized with CTFd."
        }
    }
}